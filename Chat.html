<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat</title>
    <link rel="stylesheet" type="text/css" href="Latex/mathquill.css">
    <link rel="stylesheet" href="/Latex/NewMathQuill/mathquill.css"/>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>
    <script src="/Latex/NewMathQuill/mathquill.js"></script>
    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    
    <style type="text/css">
      body{
        width:6.5in;
        margin:0 auto;
        font-family:"Times New Roman",serif;
      }
      code,#html-source{
        font-family:"Courier New",sans-serif;
      }
      a#codecogslink{
        text-decoration: none;
      }
      a#codecogslink:link span,a#codecogslink:visited span{
        text-decoration: underline;
      }
      img#codecogs{
        vertical-align:middle;
        border: none;
      }
      span.mathquill-textbox{
        width:100%;
      }
      #html-source{
        display:none;
      }
      .mathquill-rendered-math .mathquill-editable {
        min-width: 1cm;
      }
      .mathquill-editor {
        width:6.5in;
      }
    </style>
  </head>
  <body>
    <!-- CHAT MARKUP -->
    <div class="scroll-pane">
      <header>Chat, Ask Questions, and Write Solutions Here</header>
      <hr />
      <hr />
      <div id="chatMessages">
      </div>
      
    </div>


    <p><span id="mathTextBox" class="mathquill-editor"></span></p>

    
    <script type="text/javascript" src="Latex/mathquill.js"></script>

     <button onclick="Send()">Send</button> 
    <!-- CHAT JAVACRIPT -->
    <script>
      // CREATE A REFERENCE TO FIREBASE
     // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBAMYXNQs9DHykysnHyNgh4Fw8WzgOppNw",
        authDomain: "flickering-fire-5865.firebaseapp.com",
        databaseURL: "https://flickering-fire-5865.firebaseio.com",
        storageBucket: "flickering-fire-5865.appspot.com",
      };
      var app = firebase.initializeApp(config);
      var auth = app.auth();
      var database = firebase.database();
      //var messagesRef=getMessagesRef();
      var MQ = MathQuill.getInterface(2);
      //var messageList = $('#example-messages');
      var messageList=document.getElementById("chatMessages");
      var firstName="";
      var lastName="";

      function getMessagesRef()
      {
          var user = firebase.auth().currentUser;
          if(!user)
          {
            //window.location.replace("Login.html");
          }
          var uid=user.uid;
          var currentCourse="";
          var currentCourseId="";

          firebase.database().ref('/users/' + uid+'/profile').once('value').then(function(snapshot) {
            if(snapshot.val()!=null)
            {
              currentCourse=snapshot.val().currentCourse;
              currentCourseId=snapshot.val().currentCourseId;
            }
            else
            {
              currentCourse="";
              currentCourseId="";
            }
          });

          if(currentCourse!=null && currentCourse!="" && currentCourseId!=null && currentCourseId!="")
          {
            return firebase.database().ref('/'+currentCourse+'/'+ currentCourseId+'/chat');
          }
          else
          {
            return null;
          }
      }

      document.addEventListener('keypress', function(e) {
        var key = e.which || e.keyCode;
        if (key === 13) { // 13 is enter
          //FIELD VALUES
          var user = firebase.auth().currentUser;
          var uid=user.uid;
          var names = user.displayName.split(" ");
          firstName=names[0];
          lastName=names[1];
          var username = firstName+" "+lastName+": ";
          var message = $(document.getElementById("mathTextBox")).mathquill('latex');
          var currentCourse="";
          var currentCourseId="";
          //SAVE DATA TO FIREBASE AND EMPTY FIELD
          var messagesRef=getMessagesRef();
          if(messagesRef!=null)
          {
            messagesRef.push({name:username, text:message});
            $(document.getElementById("mathTextBox")).mathquill('latex')="";
          } 
        }
      });

      function Send()
      {
          //FIELD VALUES
          var user = firebase.auth().currentUser;
          var uid=user.uid;
          var names = user.displayName.split(" ");
          firstName=names[0];
          lastName=names[1];
          var username = firstName+" "+lastName+": ";
          var message = $(document.getElementById("mathTextBox")).mathquill('latex');
          var currentCourse="";
          var currentCourseId="";
          var messagesRef=getMessagesRef();
          //SAVE DATA TO FIREBASE AND EMPTY FIELD
          if(messagesRef!=null)
          {
            messagesRef.push({name:username, text:message});
            $(document.getElementById("mathTextBox")).mathquill('latex')="";
          }
      }

      // Add a callback that is triggered for each chat message.
      getMessagesRef().limitToLast(10).on('child_added', function (snapshot) {
        //GET DATA
        var data = snapshot.val();
        var username = data.name;
        var message = data.text;

        var paraUser = document.createElement("b");
        paraUser.innerHTML=username;

        var paraMessage = document.createElement("span");
        var nodeMessage = document.createTextNode(message);
        paraMessage.appendChild(nodeMessage);
        paraMessage.className="message";

        var element = document.getElementById("chatMessages");
        element.appendChild(paraUser);
        element.appendChild(paraMessage.split(':').join(' '));

        var line=document.createElement("HR");
        element.appendChild(line);

        //SCROLL TO BOTTOM OF MESSAGE LIST
        //messageList[0].scrollTop = messageList[0].scrollHeight;
        var list=document.getElementsByClassName("message");
        for (var i = 0; i < list.length; i++) {
            MQ.StaticMath(list[i]); //second console output
        }
      });

      auth.onAuthStateChanged(function(user){
          if (user) {
            
          }
          else
          {
            window.location.replace("Login.html");
          }
      });

    </script>

  </body>
</html>