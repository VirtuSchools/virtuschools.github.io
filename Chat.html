<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat</title>
    <link rel="stylesheet" type="text/css" href="Latex/mathquill.css">
    <link rel="stylesheet" href="/Latex/NewMathQuill/mathquill.css"/>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js'></script>
    <script src="/Latex/NewMathQuill/mathquill.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.1/firebase.js"></script>
    
    <style type="text/css">
      body{
        width:6.5in;
        margin:0 auto;
        font-family:"Times New Roman",serif;
      }
      code,#html-source{
        font-family:"Courier New",sans-serif;
      }
      a#codecogslink{
        text-decoration: none;
      }
      a#codecogslink:link span,a#codecogslink:visited span{
        text-decoration: underline;
      }
      img#codecogs{
        vertical-align:middle;
        border: none;
      }
      span.mathquill-textbox{
        width:100%;
      }
      #html-source{
        display:none;
      }
      .mathquill-rendered-math .mathquill-editable {
        min-width: 1cm;
      }
      .mathquill-editor {
        width:6.5in;
      }
    </style>
  </head>
  <body>
    <!-- CHAT MARKUP -->
    <div class="scroll-pane">
      <header>Chat, Ask Questions, and Write Solutions Here</header>
      <hr />
      <hr />
      <div id="chatMessages">
      </div>
      
    </div>


    <p><span id="mathTextBox" class="mathquill-editor">\sqrt[3]{8}=\frac{\sqrt{16}}{2}</span></p>

    
    <script type="text/javascript" src="Latex/mathquill.js"></script>

     <button onclick="Send()">Send</button> 
    <!-- CHAT JAVACRIPT -->
    <script>
      // CREATE A REFERENCE TO FIREBASE
      var messagesRef = new Firebase('https://flickering-fire-5865.firebaseio.com/chat');
      var ref= new Firebase('https://flickering-fire-5865.firebaseio.com/');
      var userRef;
      var MQ = MathQuill.getInterface(2);
      //var messageList = $('#example-messages');
      var messageList=document.getElementById("chatMessages");
      var firstName="";
      var lastName="";

      document.addEventListener('keypress', function(e) {
        console.log("here1");
        var key = e.which || e.keyCode;
        if (key === 13) { // 13 is enter
          //FIELD VALUES
            userRef.once("value", function (snap) {
              var userValue = snap.val();
              if (userValue==null) {
                return;
              }
                firstName=userValue.first_name;
                lastName=userValue.last_name;
           });

          console.log("username:"+firstName+" "+lastName);
          var username = firstName+" "+lastName+": ";
          var message = $(document.getElementById("mathTextBox")).mathquill('latex');

          //SAVE DATA TO FIREBASE AND EMPTY FIELD
          messagesRef.push({name:username, text:message});
          $(document.getElementById("mathTextBox")).mathquill('latex')="";
        }
      });

      function Send()
      {
            userRef.once("value", function (snap) {
              var userValue = snap.val();
              if (userValue==null) {
                return;
              }
                firstName=userValue.first_name;
                lastName=userValue.last_name;
           });

          //FIELD VALUES
          console.log("username:"+firstName+" "+lastName);
          var username = firstName+" "+lastName+": ";
          var message = $(document.getElementById("mathTextBox")).mathquill('latex');
          message=message.split(":").join("");
          console.log("Sending" + message);
          //SAVE DATA TO FIREBASE AND EMPTY FIELD
          messagesRef.push({name:username, text:message});
          $(document.getElementById("mathTextBox"));
      }

      // Add a callback that is triggered for each chat message.
      messagesRef.limitToLast(10).on('child_added', function (snapshot) {
        //GET DATA
        var data = snapshot.val();
        var username = data.name;
        var message = data.text;

        var paraUser = document.createElement("b");
        paraUser.innerHTML=username;

        var paraMessage = document.createElement("span");
        var nodeMessage = document.createTextNode(message);
        paraMessage.appendChild(nodeMessage);
        paraMessage.className="message";

        var element = document.getElementById("chatMessages");
        element.appendChild(paraUser);
        element.appendChild(paraMessage);

        var line=document.createElement("HR");
        element.appendChild(line);

        //SCROLL TO BOTTOM OF MESSAGE LIST
        //messageList[0].scrollTop = messageList[0].scrollHeight;
        var list=document.getElementsByClassName("message");
        for (var i = 0; i < list.length; i++) {
            MQ.StaticMath(list[i]); //second console output
        }
      });

      function authDataCallback(authData) {
          if (authData) {
            var user=authData.uid;
            userRef = ref.child("users").child(user);
            userRef.once("value", function (snap) {
              var userValue = snap.val();
              if (!user || userValue==null) {
                return;
              }
                firstName=userValue.first_name;
                lastName=userValue.last_name;
           });
          }
          else
          {
            window.location.replace("Login.html");
          }
      }

        // Register the callback to be fired every time auth state changes
        ref.onAuth(authDataCallback)

    </script>

  </body>
</html>